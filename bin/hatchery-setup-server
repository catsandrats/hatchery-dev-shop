#!/usr/bin/env sh

# configuration for hatchery development box
# @author: Dana Spiegel <dana@sociabledesign.com>

safe() { "$@" || barf "cannot: $*; aborting"; }
barf() { shout "$*"; exit 111; }
shout() { echo "${0##*/}: $*" >&2; }

# some default settings
OLD_DIR=`pwd`
DB_SERVER=
RUN_DIR="/var/run/hatchery"

USAGE="$0 [[[-d dbserver] [-r rundir]] | [-h]]"

while [ "$1" != "" ]; do
    case $1 in
        -d | --dbserver )
            shift
            DB_SERVER=`dig +short $1 | tac | awk 'NR > 1 { exit } ; 1'`
            ;;
        -r | --rundir )
            shift
            RUN_DIR=$1
            ;;
        -h | --help )
            shout $USAGE
            exit 0
            ;;
        * )
            barf $USAGE
    esac
    shift
done

[ "$RUN_DIR" ] || usage
[ "$DB_SERVER" ] || usage

# configure environment profile for all users
# setup hosts
safe echo "$DB_SERVER hatcherydb" | sudo tee /etc/hosts > /dev/null

# setup profile
safe sudo cp ./etc/profile.d/environment.sh /etc/profile.d/environment.sh
safe sudo sed -i "s/REPLACE_DB_SERVER/$DB_SERVER/g" /etc/profile.d/environment.sh

safe sudo -s chmod a+x /etc/profile.d/environment.sh
safe . /etc/profile.d/environment.sh

# update software installed on box
safe sudo aptitude update
safe sudo aptitude upgrade
safe sudo aptitude install git subversion emacs23-nox nginx python-flup ipython mysql-client

# install django
safe curl --location --output django-1.4.1.tar.gz https://www.djangoproject.com/download/1.4.1/tarball/ 
safe tar zxvf django-1.4.1.tar.gz 
safe cd Django-1.4.1/
safe sudo python setup.py install
safe cd ..
safe sudo rm -rf Django-1.4.1/
safe sudo rm -rf django-1.4.1.tar.gz
safe cd $OLD_DIR

# setup fcgi socket run directory
if [ -d $RUN_DIR ]; then
    safe sudo rm -rf $RUN_DIR
fi
safe sudo mkdir $RUN_DIR
safe sudo chmod a+rwxs $RUN_DIR
safe sudo chgrp www-data $RUN_DIR
