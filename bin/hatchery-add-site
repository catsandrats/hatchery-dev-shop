#!/usr/bin/env sh

# creates an nginx configuration for a user on a specified port
# @author: Dana Spiegel <dana@sociabledesign.com>

safe() { "$@" || barf "cannot: $*; aborting"; }
barf() { shout "$*"; exit 111; }
shout() { echo "${0##*/}: $*" >&2; }

USAGE="$0 [[[-u username] [-p port]] | [-h]]"

USERNAME=
PORT=

while [ "$1" != "" ]; do
    case $1 in
        -u | --username )
            shift
            USERNAME=$1
            ;;
        -p | --port )
            shift
            PORT=$1
            ;;
        -h | --help )
            shout $USAGE
            exit 0
            ;;
        * )
            barf $USAGE
    esac
    shift
done

[ "$USERNAME" ] || usage
[ "$PORT" ] || usage

safe echo "server {
    listen $PORT;
    access_log /var/log/nginx/hatchery.$USERNAME.access.log;
    error_log /var/log/nginx/hatchery.$USERNAME.error.log;

    # https://docs.djangoproject.com/en/dev/howto/static-files/#serving-static-files-in-production
    location /static/ { # STATIC_URL
        alias /home/$USERNAME/project/static/; # STATIC_ROOT
        expires 1d;
    }

    location /static/admin/ {
        alias /usr/local/lib/python2.7/dist-packages/django/contrib/admin/static/admin/;
        expires 30d;
    }

    location /media/ { # MEDIA_URL
        alias /home/$USERNAME/project/media/; # MEDIA_ROOT
        expires 1d;
    }

    location / {
        include fastcgi_params;
        fastcgi_split_path_info ^()(.*)$;
        fastcgi_pass unix:/var/run/hatchery/$USERNAME;
    }
}
" | sudo tee /etc/nginx/sites-available/$USERNAME > /dev/null


FILENAME="/etc/nginx/sites-enabled/$USERNAME"

if [ -e "$FILENAME" ]; then
    safe sudo rm "$FILENAME"
fi

safe sudo ln -s /etc/nginx/sites-available/$USERNAME "$FILENAME"

echo "Created configuration for user $USERNAME on port $PORT"

safe sudo service nginx restart

# setup private key login
