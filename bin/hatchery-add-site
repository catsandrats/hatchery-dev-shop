#!/usr/bin/env sh

# creates an nginx configuration for a user on a specified port
# @author: Dana Spiegel <dana@sociabledesign.com>

safe() { "$@" || barf "cannot: $*; aborting"; }
barf() { shout "$*"; exit 111; }
shout() { echo "${0##*/}: $*" >&2; }

usage() { barf "usage: $0 [[[-u username] [-p port]] | [-h]]"; }

USER=
PORT=

while [ "$1" != "" ]; do
    case $1 in
        -u | --user )           shift
                                USER=$1
                                ;;
        -p | --port )    		shift
                                PORT=$1
                                ;;
        -h | --help )           usage
                                exit
                                ;;
        * )                     usage
                                exit 1
    esac
    shift
done

[ "$USER" ] || usage
[ "$PORT" ] || usage

safe echo "server {
    listen $PORT;
    access_log /var/log/nginx/hatchery.$USER.access.log;
    error_log /var/log/nginx/hatchery.$USER.error.log;

    # https://docs.djangoproject.com/en/dev/howto/static-files/#serving-static-files-in-production
    location /static/ { # STATIC_URL
        alias /home/$USER/project/static/; # STATIC_ROOT
        expires 1d;
    }

    location /media/ { # MEDIA_URL
        alias /home/$USER/project/media/; # MEDIA_ROOT
        expires 1d;
    }

    location / {
        include fastcgi_params;
        fastcgi_pass unix:/var/run/hatchery/$USER;
    }
}
" | sudo tee /etc/nginx/sites-available/$USER > /dev/null


FILENAME="/etc/nginx/sites-enabled/$USER"

if [ -e "$FILENAME" ]; then
    safe sudo rm "$FILENAME"
fi

safe sudo ln -s /etc/nginx/sites-available/$USER "$FILENAME"

echo "Created configuration for user $USER on port $PORT"

safe sudo service nginx restart

# setup private key login
